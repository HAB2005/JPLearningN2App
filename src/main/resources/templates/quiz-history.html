<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch s·ª≠ l√†m b√†i - JLPT N2 Practice</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/quiz-history.css}">
    <script th:replace="~{fragments/header :: header-script}"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div th:replace="~{fragments/sidebar :: sidebar}"></div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div th:replace="~{fragments/header :: header}"></div>
            
            <!-- History Content -->
            <div class="content">
                <div class="history-header">
                    <h2>üìä L·ªãch s·ª≠ l√†m b√†i</h2>
                    <p>Xem l·∫°i c√°c l·∫ßn l√†m b√†i tr∆∞·ªõc ƒë√¢y</p>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="loading-state">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i l·ªãch s·ª≠...</p>
                </div>

                <!-- History List -->
                <div id="historyList" class="history-list" style="display: none;">
                    <!-- History items will be inserted here -->
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-icon">üìù</div>
                    <h3>Ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i</h3>
                    <p>H√£y b·∫Øt ƒë·∫ßu l√†m b√†i quiz ƒë·ªÉ xem l·ªãch s·ª≠ t·∫°i ƒë√¢y</p>
                    <a href="/quiz" class="btn-start-quiz">B·∫Øt ƒë·∫ßu l√†m b√†i</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const userId = 1; // TODO: L·∫•y t·ª´ session

        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
        });

        async function loadHistory() {
            try {
                const response = await fetch(`/api/quiz-attempts/history/${userId}`);
                if (!response.ok) throw new Error('Failed to load history');
                
                const history = await response.json();
                
                document.getElementById('loadingState').style.display = 'none';
                
                if (history.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    document.getElementById('historyList').style.display = 'block';
                    displayHistory(history);
                }
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="error-icon">‚ùå</div>
                    <p style="color: #e74c3c;">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠. Vui l√≤ng th·ª≠ l·∫°i.</p>
                `;
            }
        }

        function displayHistory(history) {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            history.forEach(attempt => {
                const card = createHistoryCard(attempt);
                historyList.appendChild(card);
            });
        }

        function createHistoryCard(attempt) {
            const card = document.createElement('div');
            card.className = 'history-card';
            
            const date = new Date(attempt.completedAt);
            const dateStr = date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const score = parseFloat(attempt.scorePercentage);
            let scoreClass = 'score-low';
            if (score >= 80) scoreClass = 'score-high';
            else if (score >= 60) scoreClass = 'score-medium';
            
            const lessonName = attempt.lesson ? attempt.lesson.name : 
                              (attempt.chapter ? attempt.chapter.name : 'Unknown');
            
            const minutes = Math.floor(attempt.timeSpent / 60);
            const seconds = attempt.timeSpent % 60;
            
            card.innerHTML = `
                <div class="history-card-header">
                    <div class="history-info">
                        <h3>${lessonName}</h3>
                        <p class="history-date">${dateStr}</p>
                    </div>
                    <div class="history-score ${scoreClass}">
                        <span class="score-value">${score}%</span>
                        <span class="score-label">${attempt.correctAnswers}/${attempt.totalQuestions}</span>
                    </div>
                </div>
                <div class="history-card-footer">
                    <div class="history-stats">
                        <span class="stat-item">‚è±Ô∏è ${minutes}:${seconds.toString().padStart(2, '0')}</span>
                        <span class="stat-item">‚úì ${attempt.correctAnswers} ƒë√∫ng</span>
                        <span class="stat-item">‚úó ${attempt.totalQuestions - attempt.correctAnswers} sai</span>
                    </div>
                    <button class="btn-view-detail" onclick="viewDetail(${attempt.id})">
                        Xem chi ti·∫øt ‚Üí
                    </button>
                </div>
            `;
            
            return card;
        }

        function viewDetail(attemptId) {
            window.location.href = `/quiz-history/${attemptId}`;
        }
    </script>
</body>
</html>
