<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√¥ng tin b√†i luy·ªán t·∫≠p - JLPT N2 Practice</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/quiz-preview.css}">
    <script th:replace="~{fragments/header :: header-script}"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div th:replace="~{fragments/sidebar :: sidebar}"></div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div th:replace="~{fragments/header :: header}"></div>
            
            <!-- Preview Content -->
            <div class="content">
                <div class="preview-container">
                    <!-- Back Button -->
                    <button class="btn-back" onclick="goBack()">‚Üê Quay l·∫°i</button>

                    <!-- Loading State -->
                    <div id="loadingState" class="loading-state">
                        <div class="spinner"></div>
                        <p>ƒêang t·∫£i th√¥ng tin...</p>
                    </div>

                    <!-- Quiz Info -->
                    <div id="quizInfo" class="quiz-info-section" style="display: none;">
                        <!-- Header Title -->
                        <div class="quiz-header-title">
                            <h1 id="quizTitle">ƒêang t·∫£i...</h1>
                            <div class="info-stats">
                                <div class="stat-item">
                                    <span class="stat-icon">üìù</span>
                                    <div class="stat-content">
                                        <span class="stat-value" id="totalQuestions">0</span>
                                        <span class="stat-label">C√¢u h·ªèi</span>
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-icon">‚è±Ô∏è</span>
                                    <div class="stat-content">
                                        <span class="stat-value" id="estimatedTime">~0</span>
                                        <span class="stat-label">Ph√∫t</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Two Column Layout -->
                        <div class="two-column-layout">
                            <!-- Left Column: Quiz Info -->
                            <div class="info-card">
                                <div class="info-description">
                                    <h3>üìã Th√¥ng tin b√†i luy·ªán t·∫≠p</h3>
                                    <ul>
                                        <li>B√†i t·∫≠p bao g·ªìm c√°c c√¢u h·ªèi v·ªÅ t·ª´ v·ª±ng v√† kanji</li>
                                        <li>B·∫°n c√≥ th·ªÉ xem l·∫°i ƒë√°p √°n sau khi ho√†n th√†nh</li>
                                        <li>K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o l·ªãch s·ª≠ l√†m b√†i</li>
                                        <li>Kh√¥ng gi·ªõi h·∫°n th·ªùi gian l√†m b√†i</li>
                                    </ul>
                                </div>

                                <button class="btn-start" onclick="startQuiz()">
                                    üöÄ B·∫Øt ƒë·∫ßu l√†m b√†i
                                </button>
                            </div>

                            <!-- Right Column: History Section -->
                            <div class="history-section">
                                <h2>üìä L·ªãch s·ª≠ l√†m b√†i</h2>
                                
                                <div id="historyLoading" class="history-loading">
                                    <div class="spinner-small"></div>
                                    <p>ƒêang t·∫£i l·ªãch s·ª≠...</p>
                                </div>

                                <div id="historyList" class="history-list" style="display: none;">
                                    <!-- History items will be inserted here -->
                                </div>

                                <div id="historyEmpty" class="history-empty" style="display: none;">
                                    <div class="empty-icon">üìù</div>
                                    <p>B·∫°n ch∆∞a l√†m b√†i n√†y l·∫ßn n√†o</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const quizType = /*[[${quizType}]]*/ 'lesson';
        const quizId = /*[[${quizId}]]*/ 1;
        const userId = 1; // TODO: Get from session

        document.addEventListener('DOMContentLoaded', function() {
            loadQuizInfo();
            loadQuizHistory();
        });

        async function loadQuizInfo() {
            try {
                const response = await fetch(`/api/quiz/${quizType}/${quizId}`);
                if (!response.ok) throw new Error('Failed to load quiz info');
                
                const data = await response.json();
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('quizInfo').style.display = 'block';
                
                const title = quizType === 'lesson' ? data.lessonName : data.chapterName;
                document.getElementById('quizTitle').textContent = title;
                document.getElementById('totalQuestions').textContent = data.totalQuestions;
                
                // Estimate time: questions * 0.8, rounded to nearest multiple of 5
                const rawMinutes = data.totalQuestions * 0.8;
                const estimatedMinutes = Math.round(rawMinutes / 5) * 5;
                document.getElementById('estimatedTime').textContent = estimatedMinutes;
                
            } catch (error) {
                console.error('Error loading quiz info:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="error-icon">‚ùå</div>
                    <p style="color: #e74c3c;">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin b√†i t·∫≠p. Vui l√≤ng th·ª≠ l·∫°i.</p>
                    <button class="btn-back" onclick="goBack()">‚Üê Quay l·∫°i</button>
                `;
            }
        }

        async function loadQuizHistory() {
            try {
                const response = await fetch(`/api/quiz-attempts/history/${userId}`);
                if (!response.ok) throw new Error('Failed to load history');
                
                const allHistory = await response.json();
                
                // Filter history for this specific quiz
                const filteredHistory = allHistory.filter(attempt => {
                    if (quizType === 'lesson') {
                        return attempt.lessonId === quizId;
                    } else {
                        return attempt.chapterId === quizId;
                    }
                });
                
                document.getElementById('historyLoading').style.display = 'none';
                
                if (filteredHistory.length === 0) {
                    document.getElementById('historyEmpty').style.display = 'block';
                } else {
                    document.getElementById('historyList').style.display = 'block';
                    displayHistory(filteredHistory);
                }
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('historyLoading').style.display = 'none';
                document.getElementById('historyEmpty').style.display = 'block';
            }
        }

        function displayHistory(history) {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            // Show only last 5 attempts
            const recentHistory = history.slice(0, 5);
            
            recentHistory.forEach(attempt => {
                const card = createHistoryCard(attempt);
                historyList.appendChild(card);
            });
        }

        function createHistoryCard(attempt) {
            const card = document.createElement('div');
            card.className = 'history-card-mini';
            
            const date = new Date(attempt.completedAt);
            const dateStr = date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const score = parseFloat(attempt.scorePercentage);
            let scoreClass = 'score-low';
            if (score >= 80) scoreClass = 'score-high';
            else if (score >= 60) scoreClass = 'score-medium';
            
            const minutes = Math.floor(attempt.timeSpent / 60);
            const seconds = attempt.timeSpent % 60;
            
            card.innerHTML = `
                <div class="history-mini-header">
                    <span class="history-date">${dateStr}</span>
                    <span class="history-score ${scoreClass}">${score}%</span>
                </div>
                <div class="history-mini-stats">
                    <span>‚úì ${attempt.correctAnswers}/${attempt.totalQuestions}</span>
                    <span>‚è±Ô∏è ${minutes}:${seconds.toString().padStart(2, '0')}</span>
                    <button class="btn-view-mini" onclick="viewDetail(${attempt.id})">Xem chi ti·∫øt</button>
                </div>
            `;
            
            return card;
        }

        function viewDetail(attemptId) {
            window.location.href = `/quiz-history/${attemptId}`;
        }

        function startQuiz() {
            window.location.href = `/quiz-practice?type=${quizType}&id=${quizId}`;
        }

        function goBack() {
            window.location.href = '/quiz';
        }
    </script>
</body>
</html>
