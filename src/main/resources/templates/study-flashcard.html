<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc flashcard - JLPT N2 Practice</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/flashcard.css}">
    <script th:replace="~{fragments/header :: header-script}"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div th:replace="~{fragments/sidebar :: sidebar}"></div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div th:replace="~{fragments/header :: header}"></div>
            
            <!-- Flashcard Content -->
            <div class="content">
                <div class="flashcard-header">
                    <div class="lesson-info">
                        <a href="/study" class="back-btn">‚Üê Quay l·∫°i</a>
                        <h2 th:text="${lesson.name}">Lesson 1</h2>
                        <p th:text="${lesson.description}">M√¥ t·∫£ b√†i h·ªçc</p>
                    </div>
                    <div class="header-right">
                        <div class="progress-info" id="progressInfo">
                            <span class="current-card" id="currentCard">1</span> / 
                            <span class="total-cards" th:text="${flashcards.size()}">20</span>
                        </div>
                        <div class="mode-switcher">
                            <div class="mode-slider"></div>
                            <button class="mode-btn" id="flashcardModeBtn" onclick="switchMode('flashcard')">
                                <span class="mode-icon">üé¥</span>
                                <span class="mode-label">Flashcard</span>
                            </button>
                            <button class="mode-btn active" id="listModeBtn" onclick="switchMode('list')">
                                <span class="mode-icon">üìã</span>
                                <span class="mode-label">Danh s√°ch</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Flashcard Mode -->
                <div id="flashcardMode" class="study-mode">
                    <!-- All Flashcards -->
                    <div th:each="card, iterStat : ${flashcards}" 
                         th:attr="data-index=${iterStat.index}"
                         th:class="${iterStat.index == 0 ? 'flashcard-container active' : 'flashcard-container'}"
                         style="display: none;">
                    
                    <div class="flashcard">
                        <div class="card-inner">
                            <!-- Front Side -->
                            <div class="card-front">
                                <div class="card-type">T·ª´ v·ª±ng</div>
                                <div class="word" th:text="${card.word}">Ë®ÄËëâ</div>
                                <div class="tap-hint">üëÜ Nh·∫•n ƒë·ªÉ xem nghƒ©a v√† c√°ch ƒë·ªçc</div>
                            </div>
                            
                            <!-- Back Side -->
                            <div class="card-back">
                                <div class="back-scroll">
                                    <div class="word-header">
                                        <div class="word-small" th:text="${card.word}">Ë®ÄËëâ</div>
                                        <div class="reading-small" th:text="${card.reading}">„Åì„Å®„Å∞</div>
                                    </div>
                                    <div class="meaning" th:text="${card.meaning}">T·ª´ ng·ªØ, ng√¥n t·ª´</div>
                                    
                                    <!-- Parse JSON note -->
                                    <th:block th:if="${card.note != null}">
                                        <script th:inline="javascript">
                                            /*<![CDATA[*/
                                            (function() {
                                                try {
                                                    var noteStr = /*[[${card.note}]]*/ '';
                                                    var noteData = JSON.parse(noteStr);
                                                    var container = document.currentScript.parentElement;
                                                    
                                                    // Kanji breakdown
                                                    if (noteData.kanji && noteData.kanji.length > 0) {
                                                        var kanjiHtml = '<div class="section-title">üìù Ph√¢n t√≠ch Kanji</div><div class="kanji-list">';
                                                        noteData.kanji.forEach(function(k) {
                                                            kanjiHtml += '<div class="kanji-item"><div class="kanji-char">' + k.char + '</div><div class="kanji-info">';
                                                            if (k.on) kanjiHtml += '<div><strong>√Çm On:</strong> ' + k.on + '</div>';
                                                            if (k.kun) kanjiHtml += '<div><strong>√Çm Kun:</strong> ' + k.kun + '</div>';
                                                            kanjiHtml += '<div><strong>Nghƒ©a:</strong> ' + k.meaning + '</div></div></div>';
                                                        });
                                                        kanjiHtml += '</div>';
                                                        
                                                        var kanjiDiv = document.createElement('div');
                                                        kanjiDiv.className = 'kanji-section';
                                                        kanjiDiv.innerHTML = kanjiHtml;
                                                        container.appendChild(kanjiDiv);
                                                    }
                                                    
                                                    // Related words
                                                    if (noteData.related && noteData.related.length > 0) {
                                                        var relatedHtml = '<div class="section-title">üîó T·ª´ li√™n quan</div><div class="related-list">';
                                                        noteData.related.forEach(function(r) {
                                                            relatedHtml += '<div class="related-item"><div class="related-word">' + r.word + ' <span class="related-reading">' + r.reading + '</span></div>';
                                                            relatedHtml += '<div class="related-meaning">' + r.meaning + '</div></div>';
                                                        });
                                                        relatedHtml += '</div>';
                                                        
                                                        var relatedDiv = document.createElement('div');
                                                        relatedDiv.className = 'related-section';
                                                        relatedDiv.innerHTML = relatedHtml;
                                                        container.appendChild(relatedDiv);
                                                    }
                                                    
                                                    // Examples
                                                    if (noteData.examples && noteData.examples.length > 0) {
                                                        var examplesHtml = '<div class="section-title">üí¨ V√≠ d·ª•</div><div class="examples-list">';
                                                        noteData.examples.forEach(function(ex) {
                                                            examplesHtml += '<div class="example-item"><div class="example-jp">' + ex.japanese + '</div>';
                                                            examplesHtml += '<div class="example-vn">' + ex.vietnamese + '</div></div>';
                                                        });
                                                        examplesHtml += '</div>';
                                                        
                                                        var examplesDiv = document.createElement('div');
                                                        examplesDiv.className = 'examples-section';
                                                        examplesDiv.innerHTML = examplesHtml;
                                                        container.appendChild(examplesDiv);
                                                    }
                                                } catch (e) {
                                                    console.error('Error parsing note:', e);
                                                }
                                            })();
                                            /*]]>*/
                                        </script>
                                    </th:block>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <div class="navigation-controls">
                    <button class="nav-btn" id="prevBtn" disabled>
                        ‚Üê Tr∆∞·ªõc
                    </button>
                    
                    <div class="card-actions">
                        <button class="action-btn" id="markLearnedBtn">
                            ‚úì ƒê√£ thu·ªôc
                        </button>
                        <button class="action-btn" id="flipBtn">
                            üîÑ L·∫≠t th·∫ª
                        </button>
                    </div>
                    
                    <button class="nav-btn" id="nextBtn">
                        Sau ‚Üí
                    </button>
                </div>

                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- List Mode -->
                <div id="listMode" class="study-mode active">
                    <div class="list-controls">
                        <div class="search-box">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm t·ª´ v·ª±ng, nghƒ©a, c√°ch ƒë·ªçc..." onkeyup="filterList()">
                        </div>
                        <div class="list-stats">
                            <span id="listCount" th:text="${flashcards.size()}">0</span> t·ª´
                        </div>
                    </div>

                    <div class="vocabulary-list" id="vocabularyList">
                        <div th:each="card, iterStat : ${flashcards}" class="vocab-item" th:attr="data-word=${card.word}, data-reading=${card.reading}, data-meaning=${card.meaning}">
                            <div class="vocab-number" th:text="${iterStat.index + 1}">1</div>
                            <div class="vocab-main">
                                <div class="vocab-word-row">
                                    <span class="vocab-word" th:text="${card.word}">Ë®ÄËëâ</span>
                                    <span class="vocab-reading" th:text="${card.reading}">„Åì„Å®„Å∞</span>
                                </div>
                                <div class="vocab-meaning" th:text="${card.meaning}">T·ª´ ng·ªØ, ng√¥n t·ª´</div>
                            </div>
                            <button class="vocab-expand-btn" onclick="toggleVocabDetail(this)">
                                <span class="expand-icon">‚ñº</span>
                            </button>
                            
                            <!-- Detail Section (Hidden by default) -->
                            <div class="vocab-detail" style="display: none;">
                                <th:block th:if="${card.note != null}">
                                    <script th:inline="javascript">
                                        /*<![CDATA[*/
                                        (function() {
                                            try {
                                                var noteStr = /*[[${card.note}]]*/ '';
                                                var noteData = JSON.parse(noteStr);
                                                var container = document.currentScript.parentElement;
                                                
                                                // Kanji breakdown
                                                if (noteData.kanji && noteData.kanji.length > 0) {
                                                    var kanjiHtml = '<div class="detail-section"><div class="detail-title">üìù Ph√¢n t√≠ch Kanji</div><div class="kanji-list-detail">';
                                                    noteData.kanji.forEach(function(k) {
                                                        kanjiHtml += '<div class="kanji-item-detail"><div class="kanji-char-detail">' + k.char + '</div><div class="kanji-info-detail">';
                                                        if (k.on) kanjiHtml += '<div><strong>√Çm On:</strong> ' + k.on + '</div>';
                                                        if (k.kun) kanjiHtml += '<div><strong>√Çm Kun:</strong> ' + k.kun + '</div>';
                                                        kanjiHtml += '<div><strong>Nghƒ©a:</strong> ' + k.meaning + '</div></div></div>';
                                                    });
                                                    kanjiHtml += '</div></div>';
                                                    container.innerHTML += kanjiHtml;
                                                }
                                                
                                                // Related words
                                                if (noteData.related && noteData.related.length > 0) {
                                                    var relatedHtml = '<div class="detail-section"><div class="detail-title">üîó T·ª´ li√™n quan</div><div class="related-list-detail">';
                                                    noteData.related.forEach(function(r) {
                                                        relatedHtml += '<div class="related-item-detail"><span class="related-word-detail">' + r.word + '</span> <span class="related-reading-detail">' + r.reading + '</span><div class="related-meaning-detail">' + r.meaning + '</div></div>';
                                                    });
                                                    relatedHtml += '</div></div>';
                                                    container.innerHTML += relatedHtml;
                                                }
                                                
                                                // Examples
                                                if (noteData.examples && noteData.examples.length > 0) {
                                                    var examplesHtml = '<div class="detail-section"><div class="detail-title">üí¨ V√≠ d·ª•</div><div class="examples-list-detail">';
                                                    noteData.examples.forEach(function(ex) {
                                                        examplesHtml += '<div class="example-item-detail"><div class="example-jp-detail">' + ex.japanese + '</div><div class="example-vn-detail">' + ex.vietnamese + '</div></div>';
                                                    });
                                                    examplesHtml += '</div></div>';
                                                    container.innerHTML += examplesHtml;
                                                }
                                            } catch (e) {
                                                console.error('Error parsing note:', e);
                                            }
                                        })();
                                        /*]]>*/
                                    </script>
                                </th:block>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/js/study-flashcard.js}"></script>
</body>
</html>
